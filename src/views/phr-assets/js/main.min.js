var editors={};function Phroses(){}function displaySaved(){$('#saved').addClass('active'),setTimeout(function(){$('#saved').removeClass('active')},5e3)}function createEditors(){$('.editor').each(function(){var e=$(this).attr('id');editors[e]=ace.edit(e),editors[e].setTheme('ace/theme/monokai'),editors[e].getSession().setMode('ace/mode/html'),editors[e].commands.addCommand({name:'Save',bindKey:{win:'Ctrl-S',mac:'Command-S'},exec:function(e){$('#pst-es').submit()},readOnly:!0})})}Phroses.errors={write:'Phroses encountered a problem writing and/or deleting files.  Please check filesystem permissions and try again.',api:'There was a problem accessing the api.  Please try again later',extract:'There was an issue extracting files from the archive.  Please check filesystem permissions and try again.',pw_length:'New password is too long, please keep it less than or equal to 50 characters.'},Phroses.formify=function(e){e.hash&&window.location.hash===e.hash&&(e.hashreqclass?$(e.hashreqclass.element).attr('class')===e.hashreqclass.class&&$(e.selector).fadeIn():$(e.selector).fadeIn()),$(e.selector)[e.action||'submit'](function(t){t.preventDefault(),t.stopPropagation();var s=e.collect.bind(this);$.ajax({url:$(this).data('url'),data:s(),method:$(this).data('method')}).then(e.success.bind(this)).catch(e.failure.bind(this))}),console.log('Formified element '+e.selector)},jQuery.fn.shake=function(e,t,s){e=void 0===e?100:e,t=void 0===t?10:t,s=void 0===s?3:s;var a=$(this);a.css('position','relative');for(var r=0;r<s+1;r++)a.animate({left:r%2==0?t:-1*t},e);return a.animate({left:0},e)},$(function(){console.log('phroses initialized'),createEditors(),$('.pst_btn, .phr-btn').click(function(e){e.preventDefault(),$(this).data('target')&&('off'===$(this).data('scroll')?$('body').addClass('noscroll'):'on'===$(this).data('scroll')&&$('body').removeClass('noscroll'),$('#'+$(this).data('target'))[$(this).data('action')]())}),$('.pst_btn').on('dragstart',function(){return!1}),$('#pst-es').bind('keydown',function(e){(e.ctrlKey||e.metaKey)&&'s'==String.fromCharCode(e.which).toLowerCase()&&(e.preventDefault(),e.stopImmediatePropagation(),$('#pst-es').submit())}),$('#pst-es-title').change(function(){$('#pst-es').submit()}),Phroses.formify({selector:'#pst-es',collect:function(){var e=$(this).serializeArray(),t={};return $('#pst-es .content').each(function(){$(this).hasClass('editor')?t[$(this).data('id')]=editors[$(this).attr('id')].getValue():t[$(this).attr('id')]=$(this).val()}),e.push({name:'id',value:$('#pid').val()}),e.push({name:'content',value:JSON.stringify(t)}),'redirect'===$('#pst-es-type').val()&&e.push({name:'type',value:'redirect'}),e},success:function(e){displaySaved(),void 0!==e.content&&$('#phr-container').html(e.content),document.title=$('#pst-es-title').val()},failure:function(e){}}),Phroses.formify({selector:'#pst-ds',collect:function(){return $(this).serializeArray()},success:function(e){location.reload()},failure:function(e){console.error('delete page error')}}),Phroses.formify({selector:'#pst-ms',collect:function(){$(this).serializeArray().push({name:'id',value:$('#pid').val()})},success:function(e){history.replaceState({},document.title,$('#puri').val()),$('#pst-ms').fadeOut(),displaySaved()},failure:function(e){}}),Phroses.formify({selector:'#pst-ns',hash:'#new',hashreqclass:{element:'#pst',class:'new'},collect:function(){return $(this).serializeArray()},success:function(e){var t=$('#pst-ns [name=title]').val();$('#pid').val(e.id),$('#pst').removeClass('new'),$('#pst').addClass('existing'),$('#phr-container').html(e.content),$('#pst-es-fields').html(e.typefields),$('#pst-es input[name=title]').val($('#pst-ns input[name=title]').val()),$('#pst-es-type').val($('#pst-ns select').val()),createEditors(),document.title=t,$('#pst-ns').fadeOut(function(){$('#pst-ns')[0].reset()})},failure:function(e){console.error(e)}}),Phroses.formify({selector:'#pst-es-type',action:'change',collect:function(){return $('#pst-es-fields').slideUp(),{type:$(this).val(),id:$('#pid').val()}},success:function(e){$('#pst-es-fields').html(e.typefields),createEditors(),void 0!==e.content&&$('#phr-container').html(e.content),$('#pst-es-fields').slideDown(),'redirect'!==data.type&&displaySaved()},failure:function(){}}),Phroses.formify({selector:'#pst-vis input',action:'change',collect:function(){return{id:$('#pid').val(),public:!0===$(this).is(':checked')?1:0}},success:function(){},error:function(){}}),Phroses.formify({selector:'#phroses-login',collect:function(){return $(this).serializeArray()},success:function(){$('#phroses-login').animate({width:0},function(){location.reload()})},failure:function(){$('#phroses-login').shake()}}),Phroses.formify({selector:'.pageman-select',action:'change',collect:function(){return{type:$(this).val(),id:$(this).parent().parent().data('id'),nocontent:!0}},success:function(){var e=$(this).parent().parent();e.addClass('saved'),setTimeout(function(){e.removeClass('saved')},1e3)},failure:function(){}}),$('.pageman-select').click(function(e){e.preventDefault()}),Phroses.formify({selector:'.pageman-delete',action:'click',collect:function(){return null},success:function(){$(this).parent().parent().slideUp(function(){$(this).remove()})},failure:function(){}}),$('#phr-upgrade-screen').submit(function(e){e.preventDefault(),$(this).fadeIn();var t=new EventSource('/admin/update/start');t.addEventListener('progress',function(e){console.log(e.data),$('.phr-progress-bar').css({width:JSON.parse(e.data).progress+'%'}),100===JSON.parse(e.data).progress&&(t.close(),$('#phr-upgrade-screen .phr-progress').addClass('done'),$('#phr-upgrade-screen h1').fadeOut(function(){$(this).html('Phroses updated to '+JSON.parse(e.data).version),$(this).fadeIn()}),setTimeout(function(){location.reload()},5e3))}),t.addEventListener('error',function(e){t.close(),console.log(e.data);var s=JSON.parse(e.data),a='';'write'==s.error&&(a='<br>debug: operation '+s.action+' on file '+s.file),$('.phr-progress-error').html(Phroses.errors[s.error]+a),$('.phr-progress').addClass('error')})}),$('.phr-update-icon').click(function(){$(this).addClass('done'),setTimeout(function(){$('#phr-upgrade-screen').submit()},1e3)}),$('#phr-new-page').submit(function(e){document.location=$('#phr-new-page input').val()+'#new'}),$('#theme-selector').change(function(){$.post('/admin',{theme:$(this).val()},function(){displaySaved()})}),$('.sys.form').submit(function(e){e.preventDefault(),e.stopPropagation();var t=$(this).serializeArray(),s={},a=$(this).data('method'),r=$('[name=\'uri\']').val()||$(this).data('uri'),i=$(this).attr('id');$('#phroses_editor .content').each(function(){$(this).hasClass('editor')?s[$(this).data('id')]=editors[$(this).attr('id')].getValue():s[$(this).attr('id')]=$(this).val()}),t.push({name:'content',value:JSON.stringify(s)}),$.ajax({url:r,data:t,method:a}).done(function(e){'phroses_editor'==i||'phroses_site_creds'==i?($('#saved').addClass('active'),setTimeout(function(){$('#saved').removeClass('active')},5e3)):'phroses_creator'==i&&(document.location='/admin/pages/'+e.id)}).fail(function(e){e=e.responseJSON,'phroses_site_creds'==i&&($('#error').html({username:'Please enter a value for the username field.',old:'The value for the old password was incorrect.',repeat:'The two new passwords do not match.'}[e.field]||Phroses.errors[e.error]),$('#error').addClass('active'),setTimeout(function(){$('#error').removeClass('active')},5e3))})})});