var controller,editors={};function Phroses(){this.adminuri=$("#phroses-script").data("adminuri")}Phroses.errors={write:"Phroses encountered a problem writing and/or deleting files.  Please check filesystem permissions and try again.",api:"There was a problem accessing the api.  Please try again later",extract:"There was an issue extracting files from the archive.  Please check filesystem permissions and try again.",pw_length:"Password is too long, please keep it less than or equal to 50 characters.",access_denied:"You do not have permission to do that.","pst-ms":{resource_exists:"The URI you are trying to move this page to already exists."},uploads:{resource_exists:"That filename already exists.",failed_upl:"There was an error uploading that file, it may be too large.",topupldir_notfound:"The /uploads directory does not exist, please create it and give Phroses write access.",siteupldir_notfound:"The uploads sub directory for this website does not exist.  Please give phroses write access to the /uploads folder."},admin:{resource_exists:"That page already exists",bad_uri:"Please use a valid uri that is not '/'"}},Phroses.formify=function(e){e.hash&&window.location.hash===e.hash&&(e.hashreqclass?$(e.hashreqclass.element).attr("class")===e.hashreqclass.class&&$(e.selector).fadeIn():$(e.selector).fadeIn()),$(document).on(e.action||"submit",e.selector,function(s){s.preventDefault(),s.stopImmediatePropagation();var t=(e.collect||function(){return $(this).serializeArray()}).bind(this)();$.ajax({url:$(this).data("url"),data:t,method:$(this).data("method")}).then(e.success.bind(this)).catch(e.failure?e.failure.bind(this):Phroses.genericError)}),console.log("Formified element <"+e.selector+">")},Phroses.updatePage=function(e,s){void 0!==e&&(document.title=e),void 0!==s&&$("#phr-container").html(s),this.reloadStyles()},Phroses.reloadStyles=function(){$("head link").each(function(){var e=$(this).attr("href"),s=!1,t=window.location.origin.replace(/http(s)?\:/g,"");"/"===e.substring(0,1)&&"/"!==e.substring(1,2)&&(s=!0),e.replace(/http(s)?\:/g,"").substring(0,t.length)===t&&(s=!0),e!==controller.adminuri+"/assets/css/main.css"&&s&&$.get(e,function(s){$("head").append('<style class="phr-reloaded" data-href="'+e+'">'+s+"</style>"),$(this).remove(),console.log("Reloaded "+e)}.bind(this))}),$(".phr-reloaded").each(function(){$.get($(this).data("href"),function(e){$(this).html(e),console.log("Reloaded Stylesheet <"+$(this).data("href")+">")}.bind(this))})},Phroses.genericError=function(e){"object"==typeof e&&(e.responseJSON&&(e=e.responseJSON),e=e.error&&Object.keys(Phroses.errors).includes(e.error)?Phroses.errors[e.error]:"Unknown Error: "+JSON.stringify(e)),$("body").append('<div id="phroses-error" class="phroses-generic-error screen dflts"><h1>Error:</h1><p>'+e+"</p></div>"),$("#phroses-error").fadeIn(),setTimeout(function(){$("#phroses-error").fadeOut(400,function(){$(this).remove()})},5e3)},Phroses.setupButtons=function(){$(".pst_btn, .phr-btn").click(function(e){e.preventDefault(),$(this).data("target")&&("off"===$(this).data("scroll")?$("body").addClass("noscroll"):"on"===$(this).data("scroll")&&$("body").removeClass("noscroll"),$("#"+$(this).data("target"))[$(this).data("action")]())}),$(".pst_btn").on("dragstart",function(){return!1})},Phroses.displaySaved=function(){$("#saved").addClass("active"),setTimeout(function(){$("#saved").removeClass("active")},5e3)},Phroses.createEditors=function(){$(".editor").each(function(){var e=$(this).attr("id");editors[e]=ace.edit(e),editors[e].setTheme("ace/theme/monokai"),editors[e].getSession().setMode("ace/mode/html"),editors[e].commands.addCommand({name:"Save",bindKey:{win:"Ctrl-S",mac:"Command-S"},exec:function(e){$("#pst-es").submit()},readOnly:!0})})},jQuery.fn.shake=function(e,s,t){e=void 0===e?100:e,s=void 0===s?10:s,t=void 0===t?3:t;var r=$(this);r.css("position","relative");for(var o=0;o<t+1;o++)r.animate({left:o%2==0?s:-1*s},e);return r.animate({left:0},e)},$(function(){if(console.log("-== Phroses Initialized ==-"),controller=new Phroses,$(document).on("click",".jlink",function(){document.location=$(this).data("href")}),$("#phr-admin-page").val())Phroses.setupButtons(),Phroses.formify({selector:"#phroses-login",success:function(){$("#phroses-login").animate({width:0},function(){location.reload()})},failure:function(){$("#phroses-login").shake()}}),Phroses.formify({selector:".pageman-select",action:"change",collect:function(){return{type:$(this).val(),id:$(this).parent().parent().data("id"),nocontent:!0}},success:function(){var e=$(this).parent().parent();e.addClass("saved"),setTimeout(function(){e.removeClass("saved")},1e3)}}),$(".pageman-select").click(function(e){e.preventDefault(),e.stopImmediatePropagation()}),Phroses.formify({selector:".pageman-delete",action:"click",collect:function(){return null},success:function(){$(this).parent().parent().slideUp(function(){$(this).remove()})}}),Phroses.formify({selector:"#theme-selector",action:"change",collect:function(){return{theme:$(this).val()}},success:function(){Phroses.displaySaved(),setTimeout(function(){location.reload()},2e3)}}),$("#phr-upgrade-screen").submit(function(e){e.preventDefault(),$(this).fadeIn();var s=new EventSource("/admin/update/start");s.addEventListener("progress",function(e){console.log(e.data),$(".phr-progress-bar").css({width:JSON.parse(e.data).progress+"%"}),100===JSON.parse(e.data).progress&&(s.close(),$("#phr-upgrade-screen .phr-progress").addClass("done"),$("#phr-upgrade-screen h1").fadeOut(function(){$(this).html("Phroses updated to "+JSON.parse(e.data).version),$(this).fadeIn()}),setTimeout(function(){location.reload()},5e3))}),s.addEventListener("error",function(e){s.close(),console.log(e.data);var t=JSON.parse(e.data),r="";"write"==t.error&&(r="<br>debug: operation "+t.action+" on file "+t.file),$(".phr-progress-error").html(Phroses.errors[t.error]+r),$(".phr-progress").addClass("error")})}),$(".phr-update-icon").click(function(){$(this).addClass("done"),setTimeout(function(){$("#phr-upgrade-screen").submit()},1e3)}),$("#phr-new-page").submit(function(e){document.location=$("#phr-new-page input").val()+"#new"}),Phroses.formify({selector:"#phroses_site_creds",success:function(){Phroses.displaySaved(),$("#phroses_site_creds input:not([name='username'])").val("")},failure:function(e){e=e.responseJSON,$("#error").html({username:"Please enter a value for the username field.",old:"The value for the old password was incorrect.",repeat:"The two new passwords do not match."}[e.field]||Phroses.errors[e.error]),$("#error").addClass("active"),setTimeout(function(){$("#error").removeClass("active")},5e3)}}),Phroses.formify({selector:".admin-uri input",action:"change",collect:function(){return{uri:$(this).val()}},success:function(){Phroses.displaySaved();var e=$(this).data("initial-value"),s=$(this).val();$(".adminlink").each(function(){$(this).attr("href",$(this).attr("href").replace(new RegExp("^"+e,"g"),s))}),history.replaceState({},document.title,$(this).val()),$(this).data("initial-value",$(this).val())},failure:function(e){$(this).val($(this).data("initial-value")),e=e.responseJSON,Phroses.genericError(Phroses.errors.admin[e.error]||Phroses.errors[e.error])}}),Phroses.formify({selector:".maintenance-select select",action:"change",collect:function(){return{maintenance:$(this).val()}},success:Phroses.displaySaved}),Phroses.formify({selector:".site-namer input",action:"change",collect:function(){return{name:$(this).val()}},success:Phroses.displaySaved}),Phroses.formify({selector:".siteurl-changer input",action:"change",collect:function(){return{url:$(this).val()}},success:function(){Phroses.displaySaved();var e=$(this).val();setTimeout(function(){window.location.href="http://"+e+window.location.pathname},2e3)}});else{var e=$("body").html();$("body").html('<div id="phr-container">'+e+"</div>"),$.post(controller.adminuri+"/api/pst",{uri:window.location.pathname},function(e){$("body").append(e.content),Phroses.setupButtons(),Phroses.createEditors(),$("#pst-es").bind("keydown",function(e){(e.ctrlKey||e.metaKey)&&"s"==String.fromCharCode(e.which).toLowerCase()&&(e.preventDefault(),e.stopImmediatePropagation(),$("#pst-es").submit())}),$("#pst-es-title").change(function(){$("#pst-es").submit()}),Phroses.formify({selector:"#pst-es",collect:function(){var e=$(this).serializeArray(),s={};return $("#pst-es .content").each(function(){$(this).hasClass("editor")?s[$(this).data("id")]=editors[$(this).attr("id")].getValue():s[$(this).attr("id")]=$(this).val()}),e.push({name:"id",value:$("#pid").val()}),e.push({name:"content",value:JSON.stringify(s)}),"redirect"===$("#pst-es-type").val()&&e.push({name:"type",value:"redirect"}),e},success:function(e){Phroses.displaySaved(),Phroses.updatePage($("#pst-es-title").val(),e.content)}}),Phroses.formify({selector:"#pst-ds",success:function(e){location.reload()}}),Phroses.formify({selector:"#pst-ms",collect:function(){var e=$(this).serializeArray();return e.push({name:"id",value:$("#pid").val()}),e},success:function(e){history.replaceState({},document.title,$("#puri").val()),$("#pst-ms").fadeOut(),Phroses.displaySaved()},failure:function(e){e=e.responseJSON,Phroses.genericError(Phroses.errors["pst-ms"][e.error]||Phroses.errors[e.error]||"An unknown error occurred.")}}),Phroses.formify({selector:"#pst-ns",hash:"#new",hashreqclass:{element:"#pst",class:"new"},success:function(e){var s=$("#pst-ns [name=title]").val();$("#pid").val(e.id),$("#pst").removeClass("new"),$("#pst").addClass("existing"),$("#phr-container").html(e.content),$("#pst-es-fields").html(e.typefields),$("#pst-es input[name=title]").val($("#pst-ns input[name=title]").val()),$("#pst-es-type").val($("#pst-ns select").val()),Phroses.createEditors(),document.title=s,$("#pst-ns").fadeOut(function(){$("#pst-ns")[0].reset()})}}),Phroses.formify({selector:"#pst-es-type",action:"change",collect:function(){return $("#pst-es-fields").slideUp(),{type:$(this).val(),id:$("#pid").val()}},success:function(s){$("#pst-es-fields").html(s.typefields),Phroses.createEditors(),void 0!==s.content&&$("#phr-container").html(s.content),$("#pst-es-fields").slideDown(),"redirect"!==e.type&&Phroses.displaySaved()}}),Phroses.formify({selector:"#pst-vis input",action:"change",collect:function(){return{id:$("#pid").val(),public:!0===$(this).is(":checked")?1:0}},success:function(){}})})}});